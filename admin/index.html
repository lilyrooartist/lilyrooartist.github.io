<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lily Roo Admin</title>
  <meta name="robots" content="noindex,nofollow" />
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/icons/favicon-32.png" />
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0c0d12;color:#eef0f7}
    .layout{display:grid;grid-template-columns:220px 1fr;min-height:100vh}
    .nav{border-right:1px solid #2a2f44;background:#0f1320;padding:16px;position:sticky;top:0;height:100vh}
    .brand{font-weight:800;margin-bottom:14px}
    .tab{display:block;width:100%;text-align:left;background:#151b2d;color:#d9def1;border:1px solid #2d3655;border-radius:10px;padding:10px 12px;margin:8px 0;cursor:pointer}
    .tab.active{background:#29406f;color:#fff;border-color:#4f79c6}
    .content{padding:22px;max-width:1300px}
    .panel{display:none}.panel.active{display:block}
    .main-grid{display:grid;grid-template-columns:minmax(0,1fr) 390px;gap:16px;align-items:start}
    .card{background:#141722;border:1px solid #2a2f44;border-radius:14px;padding:14px;margin:10px 0}
    .muted{color:#9ba3bf} a{color:#9ecbff}
    .sticky{position:sticky;top:14px}
    .post{border:1px solid #303856;border-radius:12px;padding:12px;margin:10px 0;background:#101523}
    .meta{display:flex;justify-content:space-between;gap:8px;align-items:center;margin-bottom:6px}
    .platform{font-size:12px;padding:4px 8px;border-radius:999px;background:#24304f;color:#b8d8ff}
    .time{font-size:12px;color:#9ba3bf}
    .label{font-size:12px;color:#9ba3bf;margin-top:8px}
    .btn{background:#2f62ff;color:white;border:0;border-radius:8px;padding:7px 10px;font-size:12px;cursor:pointer}
    .preview{margin-top:8px}
    .preview img,.preview video{width:100%;max-height:170px;object-fit:cover;border-radius:10px;border:1px solid #2d3550;background:#0b101c}
    .song-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .song img{width:100%;height:120px;object-fit:cover;border-radius:8px;border:1px solid #2d3550}
    .pill{display:inline-block;font-size:12px;background:#24304f;color:#b8d8ff;padding:3px 8px;border-radius:999px}
    .preset-row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .preset{background:#1e2a45;border:1px solid #3a4b75;color:#dbe7ff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
    .filter-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .filter-row select{background:#0f1320;color:#eef0f7;border:1px solid #334062;border-radius:8px;padding:6px}
    @media(max-width:1080px){.main-grid{grid-template-columns:1fr}.layout{grid-template-columns:1fr}.nav{position:static;height:auto;border-right:0;border-bottom:1px solid #2a2f44}}
  </style>
</head>
<body>
<div class="layout">
  <aside class="nav">
    <div class="brand">Lily Roo Admin</div>
    <button class="tab active" data-tab="promo">Promo</button>
    <button class="tab" data-tab="backstory">Backstory</button>
    <button class="tab" data-tab="reports">Reports</button>
    <p class="muted" style="margin-top:14px;font-size:12px">Protected by Cloudflare Access</p>
  </aside>

  <main class="content">
    <section class="panel active" id="panel-promo">
      <div class="main-grid">
        <div>
          <h1>Promo System</h1>
          <p class="muted">Overall strategy, execution docs, and growth focus (YouTube → 1,000 subscribers).</p>
          
          <div class="card" id="quickstart-card">
            <h2>Runbook Quick Start</h2>
            <div class="muted" id="last-report-ts">Last report: checking…</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
              <div>
                <h3 style="margin:4px 0">Today’s 3 actions</h3>
                <ol id="qs-today" class="muted" style="padding-left:18px"></ol>
              </div>
              <div>
                <h3 style="margin:4px 0">This week’s 2 priorities</h3>
                <ol id="qs-week" class="muted" style="padding-left:18px"></ol>
              </div>
            </div>
          </div>

<div class="card">
            <h2>Strategy Links</h2>
            <ul>
              <li><a href="/admin/content/30_PROMO_SYSTEM.md" target="_blank">30_PROMO_SYSTEM.md</a></li>
              <li><a href="/admin/content/40_RANDOM_RHYTHM_PLAYBOOK.md" target="_blank">40_RANDOM_RHYTHM_PLAYBOOK.md</a></li>
              <li><a href="/admin/content/Published_Log.csv" target="_blank">Published_Log.csv</a></li>
              <li><a href="/admin/content/20_QUIPS_BANK.csv" target="_blank">20_QUIPS_BANK.csv</a></li>
              <li><a href="/admin/content/18_OPS_RUNBOOK_DAILY_WEEKLY.md" target="_blank">Ops Runbook (Daily/Weekly)</a></li>
              <li><a href="/admin/content/19_AOL_ACCOUNT_HANDOFF.md" target="_blank">AOL Account Handoff</a></li>
            </ul>
          </div>
        </div>
        <aside class="sticky">
          <div class="card">
            <h2>Upcoming 7-Day Posts</h2>
            <p class="muted" id="future-sync" style="font-size:12px">Last synced: —</p>
            <div id="future-posts" class="muted">Loading…</div>
          </div>
        </aside>
      </div>
    </section>

    <section class="panel" id="panel-backstory">
      <h1>Backstory</h1>
      <p class="muted">Organized canon + full catalog packs (backstory + visuals).</p>

      <div class="card">
        <h2>Core Backstory Files</h2>
        <ul>
          <li><a href="/admin/content/00_CANON.md" target="_blank">00_CANON.md</a></li>
          <li><a href="/admin/content/10_ANECDOTE_BANK.md" target="_blank">10_ANECDOTE_BANK.md</a></li>
          <li><a href="/admin/content/11_LYRIC_BACKSTORY_INDEX.csv" target="_blank">11_LYRIC_BACKSTORY_INDEX.csv</a></li>
          <li><a href="/admin/content/12_SONG_BACKSTORY_CARDS.md" target="_blank">12_SONG_BACKSTORY_CARDS.md</a></li>
          <li><a href="/admin/content/15_BRAINROT_CAPTION_PACKS.md" target="_blank">Brain Rot Caption Packs</a></li>
          <li><a href="/admin/content/17_TOP10_CANON_PACKS.md" target="_blank">Top 10 Canon Packs</a></li>
        </ul>
      </div>

      <div class="card">
        <h2>Archive Song Packs</h2>
        <div class="preset-row">
          <button class="preset" data-preset="needs-backstory">Needs backstory</button>
          <button class="preset" data-preset="ready-week">Ready to post this week</button>
          <button class="preset" data-preset="analog-cluster">Analog Myth cluster</button>
          <button class="preset" data-preset="brain-rot">Brain Rot callbacks</button>
          <button class="preset" data-preset="clear">Clear</button>
          <button class="preset" id="copy-view">Copy view URL</button>
        </div>
        <div class="filter-row">
          <label>Era <select id="f-era"><option value="">All</option></select></label>
          <label>Type <select id="f-type"><option value="">All</option></select></label>
          <label>Status <select id="f-status"><option value="">All</option></select></label>
        </div>
        <div id="song-catalog" class="song-grid"></div>
      </div>
    </section>

    <section class="panel" id="panel-reports">
      <h1>Reports</h1>
      <div class="card">
        <ul>
          <li><a href="/admin/reports/" target="_blank">Weekly Reports Index</a></li>
          <li><a href="/admin/reports/weekly-social-report.md" target="_blank">Weekly Social Report</a></li>
        </ul>
      </div>
    </section>
  </main>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const setParam = (k,v)=>{ if(v) params.set(k,v); else params.delete(k); history.replaceState({},'',`${location.pathname}?${params.toString()}`); };

  document.querySelectorAll('.tab').forEach(btn=>btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab=btn.dataset.tab;
    document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
    document.getElementById('panel-'+tab).classList.add('active');
    setParam('tab',tab);
  }));

  const initialTab=params.get('tab');
  if(initialTab && document.querySelector(`.tab[data-tab="${initialTab}"]`)) document.querySelector(`.tab[data-tab="${initialTab}"]`).click();

  const formatDate=(iso)=>new Date(iso).toLocaleString('en-US',{month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
  const now=new Date(), in7=new Date(now.getTime()+7*24*60*60*1000);

  function renderImagePreview(el,p){
    const src=(p.imagery_url||'').trim();
    if(!src){el.innerHTML='';return;}
    const lower=src.toLowerCase();
    if(/\.(png|jpg|jpeg|gif|webp)(\?|$)/.test(lower)) el.innerHTML=`<div class="label"><b>Image</b></div><img src="${src}" alt="image preview" loading="lazy"/>`;
    else el.innerHTML=`<div class="label"><b>Image</b>: <a href="${src}" target="_blank" rel="noopener">Open ↗</a></div>`;
  }

  function renderClipPreview(el,p){
    const src=(p.clip_url||'').trim();
    if(!src){el.innerHTML='';return;}
    const lower=src.toLowerCase();
    if(/\.(mp4|webm|mov)(\?|$)/.test(lower)) el.innerHTML=`<div class="label"><b>Clip</b></div><video src="${src}" controls muted playsinline preload="metadata"></video>`;
    else el.innerHTML=`<div class="label"><b>Clip</b>: <a href="${src}" target="_blank" rel="noopener">Open ↗</a></div>`;
  }


  async function loadQuickStart(){
    const todayEl=document.getElementById('qs-today');
    const weekEl=document.getElementById('qs-week');
    const tsEl=document.getElementById('last-report-ts');
    if(!todayEl||!weekEl||!tsEl) return;

    // Source today/week from one JSON
    try{
      const q=await fetch('/admin/content/runbook_quickstart.json').then(r=>r.json());
      (q.today_actions||[]).forEach(x=>{ const li=document.createElement('li'); li.textContent=x; todayEl.appendChild(li); });
      (q.week_priorities||[]).forEach(x=>{ const li=document.createElement('li'); li.textContent=x; weekEl.appendChild(li); });
      if(!(q.today_actions||[]).length){ todayEl.innerHTML='<li>Not configured yet</li>'; }
      if(!(q.week_priorities||[]).length){ weekEl.innerHTML='<li>Not configured yet</li>'; }
    }catch(e){
      todayEl.innerHTML='<li>Quick-start config unavailable</li>';
      weekEl.innerHTML='<li>Quick-start config unavailable</li>';
    }

    // Auto-read report timestamp from report Last updated line; fallback if missing
    try{
      const md=await fetch('/admin/reports/weekly-social-report.md').then(r=>r.ok?r.text():'');
      const m=md.match(/\*\*Last updated:\*\*\s*(.+)/i);
      if(m && m[1]) tsEl.textContent='Last report: '+m[1].trim();
      else tsEl.textContent='Last report: not yet generated';
    }catch(e){
      tsEl.textContent='Last report: not yet generated';
    }
  }
  loadQuickStart();

  fetch('/admin/future-posts.json').then(r=>r.json()).then(payload=>{
    const list=Array.isArray(payload)?payload:(payload.posts||[]);
    if(payload.last_synced) document.getElementById('future-sync').textContent='Last synced: '+formatDate(payload.last_synced);
    const posts=list.filter(p=>{const t=new Date(p.scheduled_at); return t>=now && t<=in7;}).sort((a,b)=>new Date(a.scheduled_at)-new Date(b.scheduled_at));
    const container=document.getElementById('future-posts');
    if(!posts.length){container.textContent='No upcoming posts.';return;}
    container.innerHTML='';
    posts.forEach(p=>{
      const key=`redo_${p.id}`; const idx=Number(localStorage.getItem(key)||0)%(p.drafts?.length||1);
      const text=(p.drafts&&p.drafts.length)?p.drafts[idx]:p.text;
      const d=document.createElement('div'); d.className='post';
      const statusKey=`status_${p.id}`;
      const statusVal=localStorage.getItem(statusKey)||'queued';
      d.innerHTML=`<div class="meta"><span class="platform">${p.platform}</span><span class="time">${formatDate(p.scheduled_at)}</span></div>
      <div class="label"><b>Status</b>: <span data-role="status">${statusVal}</span></div>
      <div><b>Text</b>: <span data-role="text">${text}</span></div>
      <div class="label"><b>Imagery</b>: ${p.imagery||''}</div>
      <div class="preview" data-role="preview-image"></div>
      <div class="preview" data-role="preview-clip"></div>
      <div class="label" style="margin-top:10px"><button class="btn" data-role="redo">Redo</button> <button class="btn" data-role="exec">Execute now</button></div>`;
      renderImagePreview(d.querySelector('[data-role="preview-image"]'),p);
      renderClipPreview(d.querySelector('[data-role="preview-clip"]'),p);
      d.querySelector('[data-role="redo"]').addEventListener('click',()=>{
        if(!p.drafts||!p.drafts.length) return;
        const n=(Number(localStorage.getItem(key)||0)+1)%p.drafts.length;
        localStorage.setItem(key,String(n)); d.querySelector('[data-role="text"]').textContent=p.drafts[n];
      });
      d.querySelector('[data-role="exec"]').addEventListener('click',()=>{
        const txt=encodeURIComponent(d.querySelector('[data-role="text"]').textContent);
        let url='';
        const platform=(p.platform||'').toLowerCase();
        if(platform.includes('x')) url=`https://x.com/intent/post?text=${txt}`;
        else if(platform.includes('facebook')) url=`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent('https://lilyroo.com')}&quote=${txt}`;
        else if(platform.includes('instagram')) url='https://www.instagram.com/';
        else if(platform.includes('tiktok')) url='https://www.tiktok.com/upload';
        else if(platform.includes('youtube')) url='https://studio.youtube.com/';
        if(url) window.open(url,'_blank');
        const posted=prompt('Paste published URL (or leave blank to keep queued):');
        if(posted){
          localStorage.setItem(statusKey,'posted');
          localStorage.setItem(`posted_url_${p.id}`,posted);
          d.querySelector('[data-role="status"]').textContent='posted';
        }
      });
      container.appendChild(d);
    });
  });

  fetch('/admin/backstory/catalog.json').then(r=>r.json()).then(data=>{
    const all=data.songs||[];
    const eraSel=document.getElementById('f-era'), typeSel=document.getElementById('f-type'), statusSel=document.getElementById('f-status');
    const uniq=(arr,key)=>[...new Set(arr.map(x=>x[key]).filter(Boolean))].sort();
    uniq(all,'era').forEach(v=>eraSel.insertAdjacentHTML('beforeend',`<option>${v}</option>`));
    uniq(all,'song_type').forEach(v=>typeSel.insertAdjacentHTML('beforeend',`<option>${v}</option>`));
    uniq(all,'status').forEach(v=>statusSel.insertAdjacentHTML('beforeend',`<option>${v}</option>`));

    const root=document.getElementById('song-catalog');
    function applyPreset(name){
      if(name==='needs-backstory'){ eraSel.value='Archive'; statusSel.value='Draft'; typeSel.value='Song'; }
      else if(name==='ready-week'){ statusSel.value='In Progress'; eraSel.value='Current'; typeSel.value='Song'; }
      else if(name==='analog-cluster'){ eraSel.value='Current'; typeSel.value='Song'; statusSel.value='In Progress'; }
      else if(name==='brain-rot'){ eraSel.value='Archive'; typeSel.value='Song'; statusSel.value='Draft'; }
      else { eraSel.value=''; typeSel.value=''; statusSel.value=''; }
      setParam('preset', name==='clear' ? '' : name);
      render();
    }

    function render(){
      const era=eraSel.value, typ=typeSel.value, st=statusSel.value;
      setParam('era',era); setParam('type',typ); setParam('status',st);
      const list=all.filter(s=>(!era||s.era===era)&&(!typ||s.song_type===typ)&&(!st||s.status===st));
      root.innerHTML='';
      list.forEach(s=>{
        const d=document.createElement('div'); d.className='card song';
        d.innerHTML=`<div class="pill">${s.id}</div> <span class="muted">${s.era} · ${s.song_type} · ${s.status}</span><h3>${s.title}</h3>
        ${s.thumb?`<a href="${s.url}" target="_blank"><img src="${s.thumb}" alt="${s.title}"></a>`:''}
        <p><a href="${s.backstory_file}" target="_blank">Backstory Pack</a> · <a href="${s.visual_file}" target="_blank">Visual Pack</a> · <a href="${s.url}" target="_blank">YouTube</a></p>`;
        root.appendChild(d);
      });
    }

    document.querySelectorAll('[data-preset]').forEach(b=>b.addEventListener('click',()=>applyPreset(b.dataset.preset)));
    document.getElementById('copy-view').addEventListener('click',async()=>{
      await navigator.clipboard.writeText(location.href);
      document.getElementById('copy-view').textContent='Copied!';
      setTimeout(()=>document.getElementById('copy-view').textContent='Copy view URL',1000);
    });

    // hydrate from URL state
    if(params.get('era')) eraSel.value=params.get('era');
    if(params.get('type')) typeSel.value=params.get('type');
    if(params.get('status')) statusSel.value=params.get('status');
    const preset=params.get('preset');
    if(preset && !params.get('era') && !params.get('type') && !params.get('status')) applyPreset(preset); else render();

    [eraSel,typeSel,statusSel].forEach(el=>el.addEventListener('change',()=>{ setParam('preset',''); render(); }));
  });
</script>
</body>
</html>
